// Generated by CoffeeScript 1.10.0
var parse;

parse = function(dataArray) {
  var ages, ethnicities, nested_data, percentages, sumDisability;
  sumDisability = function(arr, val) {
    return d3.sum(arr, function(d) {
      if (d.c_disability.value === val) {
        return d.obs_value.value;
      }
    });
  };
  nested_data = d3.nest().key(function(d) {
    return d.c_ethpuk11.description;
  }).key(function(d) {
    return d.c_age.description;
  }).rollup(function(values) {
    return {
      sum: d3.sum(values, function(d) {
        return d.obs_value.value;
      }),
      limited_a_lot: sumDisability(values, 1),
      limited_a_little: sumDisability(values, 2),
      not_limited: sumDisability(values, 3)
    };
  }).entries(dataArray);
  percentages = nested_data.map(function(ethnicity) {
    return {
      key: ethnicity.key,
      values: ethnicity.values.map(function(age) {
        return {
          key: age.key,
          ethnicity: ethnicity.key,
          values: {
            limited_a_lot: age.values.limited_a_lot / age.values.sum,
            limited_a_little: age.values.limited_a_little / age.values.sum,
            not_limited: age.values.not_limited / age.values.sum
          }
        };
      })
    };
  });
  ethnicities = nested_data.map(function(ethnicity) {
    return ethnicity.key;
  });
  ages = nested_data[0].values.map(function(age) {
    return age.key;
  });
  return {
    ethnicities: ethnicities,
    percentages: percentages,
    nested_data: nested_data,
    ages: ages
  };
};

module.exports = parse;

//# sourceMappingURL=health-disability-parser.map
