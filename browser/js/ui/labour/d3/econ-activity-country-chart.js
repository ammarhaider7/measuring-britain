// Generated by CoffeeScript 1.10.0
var drawEconByCountryChart;

drawEconByCountryChart = function(options) {
  var activeCategory, activeValue, attachHoverHandlers, chart_height, chart_width, container, countries, d3_array, data, employment_cats, employment_cats_concat, format, height, in_work_colours, in_work_colours_domain, in_work_colours_range, isDefault, key, margin, my, onInitDone, onMouseOver, out_of_work_colours, out_of_work_colours_domains, out_of_work_range, percFormat, pointPercFormat, ref, ref1, trimCountryString, width, x, xAxis, y, y0, yAxisBottom, yAxisTop;
  container = options.container, data = options.data, isDefault = options.isDefault, onMouseOver = options.onMouseOver, activeCategory = options.activeCategory, activeValue = options.activeValue, onInitDone = options.onInitDone;
  my = {};
  width = (ref = $(container).width()) != null ? ref : 800;
  height = (ref1 = $(container).height()) != null ? ref1 : 550;
  margin = {
    top: 35,
    right: 20,
    bottom: 45,
    left: 40,
    p: 25,
    label: 60
  };
  chart_width = width - margin.left - margin.right;
  chart_height = height - margin.top - margin.bottom;
  format = d3.format('.2s');
  percFormat = d3.format(',.0%');
  pointPercFormat = d3.format(',.2%');
  d3_array = data.percentages;
  countries = data.countries;
  employment_cats = data.employment_cats_pretty;
  employment_cats_concat = data.employment_cats_concat;
  key = function(d) {
    return d.country;
  };
  in_work_colours_domain = ["employee", "self_employed"];
  in_work_colours_range = ['#74c476', '#98df8a'];
  in_work_colours = d3.scale.ordinal().domain(in_work_colours_domain).range(in_work_colours_range);
  out_of_work_colours_domains = ["unemployed", "retired", "student", "other", "looking_after_home_family", "long_term_sick_disabled"];
  out_of_work_range = ['#C54E58', '#D6616B', '#B33742', '#E47982', '#F38F97', '#FDABB1'];
  out_of_work_colours = d3.scale.ordinal().domain(out_of_work_colours_domains).range(out_of_work_range);
  trimCountryString = function(str) {
    if (str.indexOf('Antarctica') > -1) {
      return 'Oceanian countries';
    } else if (str.indexOf('EU countries') > -1) {
      return 'EU countries';
    } else if (str.indexOf('Africa') > -1) {
      return 'African countries';
    } else if (str.indexOf('Rest of Europe') > -1) {
      return 'Non-EU European countries';
    } else if (str.indexOf('United Kingdom') > -1) {
      return 'United Kingdom';
    } else if (str.indexOf('Americas') > -1) {
      return 'Americas & Carribean';
    } else if (str.indexOf('Middle') > -1) {
      return 'Asia & Middle East';
    }
  };
  x = d3.scale.ordinal().domain(countries).rangeRoundBands([0, chart_width], 0.35);
  y = d3.scale.linear().domain([0, 1]).range([0.5 * chart_height, 0]);
  y0 = d3.scale.linear().domain([0, 1]).range([0, 0.5 * chart_height]);
  xAxis = d3.svg.axis().scale(x).orient('bottom');
  yAxisTop = d3.svg.axis().scale(y).ticks(5).tickSize(-chart_width).tickFormat(percFormat).orient('left');
  yAxisBottom = d3.svg.axis().scale(y0).ticks(5).tickSize(-chart_width).tickFormat(percFormat).orient('left');
  my.init = function() {
    var bottom_countries, bottom_rect_group, legend_group, main_bottom_group, main_top_group, svg, title_group, top_countries, top_rect_group, x_axis_divider_group, x_axis_group, y_axis_bottom_group, y_axis_top_group;
    svg = d3.select('.econ-country-svg');
    main_top_group = svg.select('.main-group-top');
    main_bottom_group = svg.select('.main-group-bottom');
    x_axis_group = svg.select('.x.axis');
    y_axis_top_group = svg.select('.y.y-top.axis');
    y_axis_bottom_group = svg.select('.y.y-bottom.axis');
    title_group = svg.select('.title-group');
    legend_group = svg.select('.legend-group');
    x_axis_divider_group = svg.select('.x-axis-divider');
    top_rect_group = svg.select('.top-group-rect');
    bottom_rect_group = svg.select('.bottom-group-rect');
    main_top_group.attr('transform', "translate(" + margin.left + ", " + margin.top + ")");
    main_bottom_group.attr('transform', "translate(" + margin.left + ", " + ((chart_height / 2) + margin.top) + ")");
    x_axis_group.attr('transform', "translate(" + margin.left + ", " + ((chart_height / 2) + margin.top) + ")");
    x_axis_divider_group.attr('transform', "translate(" + margin.left + ", " + ((chart_height / 2) + margin.top) + ")");
    top_rect_group.attr('transform', "translate(" + margin.left + ", " + margin.top + ")");
    y_axis_top_group.attr('transform', "translate(" + margin.left + ", " + margin.top + ")");
    y_axis_bottom_group.attr('transform', "translate(" + margin.left + ", " + ((chart_height / 2) + margin.top) + ")");
    bottom_rect_group.attr('transform', "translate(" + margin.left + ", " + ((chart_height / 2) + margin.top) + ")");
    title_group.attr('transform', "translate(" + (chart_width / 2 + margin.left) + ", 0)");
    legend_group.attr('transform', "translate(" + (chart_width - margin.p) + ", " + margin.top + ")");
    top_rect_group.append('rect').attr({
      width: chart_width,
      x: 0,
      height: 0.5 * chart_height,
      fill: 'rgba(152, 223, 138, 0.47)',
      opacity: 0
    }).transition().duration(1500).attr('opacity', 0.3);
    main_top_group.append('text').attr({
      x: chart_width * 0.5,
      y: margin.label,
      "class": 'in-work-label',
      opacity: 0
    }).text('In work').transition().duration(1500).attr('opacity', 0.5);
    bottom_rect_group.append('rect').attr({
      width: chart_width,
      x: 0,
      height: 0.5 * chart_height,
      fill: '#FFCFCF',
      opacity: 0
    }).transition().duration(1500).attr('opacity', 0.3);
    main_bottom_group.append('text').attr({
      x: chart_width * 0.5,
      y: chart_height * 0.5 - margin.label,
      "class": 'out-of-work-label',
      opacity: 0
    }).text('Not in work').transition().duration(1500).attr('opacity', 0.5);
    x_axis_group.transition().duration(1500).call(xAxis);
    y_axis_top_group.transition().duration(1500).call(yAxisTop);
    y_axis_top_group.append("text").attr("transform", "rotate(-90)").attr("y", 6).attr("dy", ".71em").style("text-anchor", "end").text("% of Population");
    y_axis_bottom_group.transition().duration(1500).call(yAxisBottom);
    top_countries = main_top_group.selectAll('.country-g').data(d3_array, key).enter().append('g').attr('transform', function(d) {
      return "translate(" + (x(d.country)) + ", 0)";
    }).attr('class', 'country-g');
    bottom_countries = main_bottom_group.selectAll('.country-g').data(d3_array, key).enter().append('g').attr('transform', function(d) {
      return "translate(" + (x(d.country)) + ", 0)";
    }).attr('class', 'country-g');
    top_countries.append('text').text(function(d) {
      return trimCountryString(d.country);
    }).attr({
      x: -(chart_height * 0.5) + 3,
      y: -3,
      transform: "rotate(-90)",
      'font-size': '80%',
      "class": 'country-label',
      opacity: 0
    }).transition().duration(1500).attr('opacity', 1);
    top_countries.selectAll('rect').data(function(d) {
      return d.in_work_categories;
    }).enter().append('rect').attr({
      width: x.rangeBand(),
      y: chart_height * 0.5,
      height: 0,
      fill: function(d) {
        return in_work_colours(d.name);
      },
      "class": 'rect'
    }).transition().duration(1500).attr({
      y: function(d) {
        return y(d.y1);
      },
      height: function(d) {
        return (y(d.y0)) - (y(d.y1));
      }
    });
    bottom_countries.selectAll('rect').data(function(d) {
      return d.out_of_work_categories;
    }).enter().append('rect').attr({
      width: x.rangeBand(),
      y: 0,
      height: 0,
      fill: function(d) {
        return out_of_work_colours(d.name);
      },
      "class": 'rect'
    }).transition().duration(1500).attr({
      y: function(d) {
        return y0(d.y0);
      },
      height: function(d) {
        return (y0(d.y1)) - (y0(d.y0));
      }
    });
    x_axis_divider_group.append('line').attr({
      stroke: 'black',
      'stroke-width': 1,
      x1: 0,
      x2: chart_width,
      y1: 0,
      y2: 0,
      opacity: 0
    }).transition().duration(1500).attr('opacity', 1);
    return attachHoverHandlers();
  };
  my.update = function() {
    var bottom_countries, main_bottom_group, main_top_group, svg, top_countries;
    svg = d3.select('.econ-country-svg');
    main_top_group = svg.select('.main-group-top');
    main_bottom_group = svg.select('.main-group-bottom');
    top_countries = main_top_group.selectAll('.country-g').data(d3_array, key);
    top_countries.transition().duration(1000).attr('transform', function(d) {
      return "translate(" + (x(d.country)) + ", 0)";
    });
    bottom_countries = main_bottom_group.selectAll('.country-g').data(d3_array, key);
    bottom_countries.transition().duration(1000).attr('transform', function(d) {
      return "translate(" + (x(d.country)) + ", 0)";
    });
    top_countries.selectAll('rect').data(function(d) {
      return d.in_work_categories;
    }).transition().duration(1000).attr({
      y: function(d) {
        return y(d.y1);
      },
      height: function(d) {
        return (y(d.y0)) - (y(d.y1));
      }
    });
    bottom_countries.selectAll('rect').data(function(d) {
      return d.out_of_work_categories;
    }).transition().duration(1000).attr({
      y: function(d) {
        return y0(d.y0);
      },
      height: function(d) {
        return (y0(d.y1)) - (y0(d.y0));
      }
    });
    return attachHoverHandlers();
  };
  attachHoverHandlers = function() {
    var bottom_rects, hover_colour, main_bottom_group, main_top_group, svg, top_rects;
    hover_colour = '#03A9F4';
    svg = d3.select('.econ-country-svg');
    countries = svg.selectAll('.country-g');
    main_top_group = svg.select('.main-group-top');
    main_bottom_group = svg.select('.main-group-bottom');
    top_rects = main_top_group.selectAll('.rect');
    bottom_rects = main_bottom_group.selectAll('.rect');
    top_rects.on('mouseover', function(d) {
      var $this;
      console.log(d);
      $this = d3.select(this);
      return $this.attr('fill', hover_colour);
    }).on('mouseout', function(d) {
      var $this;
      $this = d3.select(this);
      return $this.attr('fill', function(d) {
        return in_work_colours(d.name);
      });
    });
    return bottom_rects.on('mouseover', function(d) {
      var $this;
      console.log(d);
      $this = d3.select(this);
      return $this.attr('fill', hover_colour);
    }).on('mouseout', function(d) {
      var $this;
      $this = d3.select(this);
      return $this.attr('fill', function(d) {
        return out_of_work_colours(d.name);
      });
    });
  };
  my.width = function(value) {
    if (!arguments.length) {
      return width;
    }
    width = value;
    return my;
  };
  my.height = function(value) {
    if (!arguments.length) {
      return height;
    }
    height = value;
    return my;
  };
  return my;
};

module.exports = drawEconByCountryChart;

//# sourceMappingURL=econ-activity-country-chart.map
